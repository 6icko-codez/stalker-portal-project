# Stream URL Fix - Applied Solution

## Problem Summary
The video player was failing because the stream URL generated by the API had an empty `stream` parameter:
```
http://portal.com/play/live.php?mac=...&stream=&extension=ts&play_token=...
                                        ^^^^^^^ EMPTY!
```

## Root Cause
The `createLink` method in `src/lib/stalker-api.ts` was receiving the `channelId` parameter but **not including it** in the API request to the Stalker portal. The Stalker portal's `create_link` action requires an `id` parameter to identify which channel's stream URL to generate.

### Code Flow Before Fix:
1. Frontend sends: `channelId: channel.externalId` ✅
2. API route receives and passes: `api.createLink(cmd, channelId)` ✅
3. `createLink` method **ignores** `channelId` ❌
4. Portal receives request without channel ID ❌
5. Portal returns URL with empty `stream` parameter ❌

## Solution Applied

### File 1: `/vercel/sandbox/src/lib/stalker-api.ts`

**Change:** Added `id: channelId` parameter to the Stalker portal API request.

```typescript
// BEFORE (Line 273):
const data = await this.makeRequest('itv', {
  action: 'create_link',
  cmd: encodeURIComponent(cmd),
  series: '',
  forced_storage: 'undefined',
  disable_ad: '0',
  download: '0',
  JsHttpRequest: '1-xml',
});

// AFTER:
const data = await this.makeRequest('itv', {
  action: 'create_link',
  cmd: encodeURIComponent(cmd),
  id: channelId, // ⭐ CRITICAL FIX: Include channel ID in the request
  series: '',
  forced_storage: 'undefined',
  disable_ad: '0',
  download: '0',
  JsHttpRequest: '1-xml',
});
```

### File 2: Enhanced Logging

Added extensive logging throughout the flow to track the `channelId`:

**In `stalker-api.ts`:**
- Log channelId when `createLink` is called
- Log portal response details
- Log URL extraction steps
- Validate that `stream` parameter is present in final URL

**In `src/app/api/iptv/stalker/stream/route.ts`:**
- Log channelId type and length in request parameters
- Log before calling `createLink`
- Log the returned stream URL

## Expected Result

After this fix, the stream URL should now contain a valid channel ID:
```
http://portal.com/play/live.php?mac=...&stream=12345&extension=ts&play_token=...
                                        ^^^^^^^^^^^^^ POPULATED!
```

## Testing Instructions

1. **Start the development server** (if not already running):
   ```bash
   npm run dev
   ```

2. **Open the application** in your browser

3. **Try to play a channel** from the channel list

4. **Check the browser console** for the video player error

5. **Check the server logs** for detailed debugging information:
   - Look for `[StalkerAPI.createLink]` logs showing the channelId
   - Look for `[Stream API]` logs showing the request flow
   - Verify the final stream URL has a populated `stream` parameter

6. **Test in VLC** (optional):
   - Copy the generated stream URL from the logs
   - Open VLC → Media → Open Network Stream
   - Paste the URL and verify it plays

## Verification Points

✅ **channelId is logged** in the API route request parameters  
✅ **channelId is passed** to `createLink` method  
✅ **id parameter is included** in the Stalker portal API request  
✅ **Stream URL contains** a non-empty `stream` parameter  
✅ **Video player loads** the stream successfully  
✅ **VLC can play** the stream URL  

## Additional Notes

- The fix is minimal and surgical - only adds the missing `id` parameter
- All existing functionality remains unchanged
- Extensive logging helps diagnose any future issues
- The logging can be reduced once the fix is confirmed working

## Files Modified

1. `/vercel/sandbox/src/lib/stalker-api.ts` - Added `id: channelId` parameter + logging
2. `/vercel/sandbox/src/app/api/iptv/stalker/stream/route.ts` - Enhanced logging

## Rollback Instructions

If needed, the changes can be reverted using:
```bash
git checkout HEAD -- src/lib/stalker-api.ts src/app/api/iptv/stalker/stream/route.ts
```
